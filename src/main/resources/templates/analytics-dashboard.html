<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <div th:replace="~{fragments/header :: header}"></div>
        <h1>Analytics Dashboard</h1>
        
        <div class="form-section">
            <h3>Revenue Analytics</h3>
            <div style="display: flex; gap: 20px; margin-bottom: 20px; align-items: center;">
                <div>
                    <label>Select Year:</label>
                    <select onchange="window.location.href='/analytics?year='+this.value" style="padding: 8px; width: 150px;">
                        <option th:each="y : ${#numbers.sequence(2020, 2030)}" 
                                th:value="${y}" 
                                th:text="${y}"
                                th:selected="${y == selectedYear}"></option>
                    </select>
                </div>
            </div>
            
            <!-- Bar Chart -->
            <div style="max-width: 900px; margin: 20px auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <h4 style="text-align: center; color: #6366f1; margin-bottom: 15px;">Monthly Revenue Chart</h4>
                <canvas id="monthlyChart" style="max-height: 400px;"></canvas>
            </div>
            
            <!-- Table View -->
            <div style="max-width: 900px; margin: 20px auto;">
                <h4 style="text-align: center; color: #6366f1; margin-bottom: 15px;">Monthly Revenue Table</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Month</th>
                            <th>Revenue (₹)</th>
                            <th>% of Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="month : ${monthlyData}">
                            <td th:text="${month.key}"></td>
                            <td th:text="'₹' + ${#numbers.formatDecimal(month.value, 1, 2)}"></td>
                            <td th:text="${totalRevenue > 0 ? #numbers.formatDecimal((month.value / totalRevenue) * 100, 1, 1) + '%' : '0%'}"></td>
                        </tr>
                        <tr style="font-weight: bold; background: #f5f5f5;">
                            <td>TOTAL</td>
                            <td th:text="'₹' + ${#numbers.formatDecimal(totalRevenue, 1, 2)}"></td>
                            <td>100%</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="form-section">
            <h3>Top 10 Clients by Revenue</h3>
            <table>
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Client Name</th>
                        <th>Total Revenue</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="client, stat : ${topClients}">
                        <td th:text="${stat.count}"></td>
                        <td th:text="${client.name}"></td>
                        <td th:text="'₹' + ${#numbers.formatDecimal(client.totalValue, 1, 2)}"></td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="form-section">
            <h3>GST Summary Report</h3>
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <input type="date" id="gstStartDate" style="padding: 8px;">
                <input type="date" id="gstEndDate" style="padding: 8px;">
                <button onclick="loadGSTSummary()" class="btn">Generate Report</button>
            </div>
            <div id="gstSummary" style="display: none;">
                <p><strong>Total CGST:</strong> ₹<span id="totalCGST">0.00</span></p>
                <p><strong>Total SGST:</strong> ₹<span id="totalSGST">0.00</span></p>
                <p><strong>Total GST:</strong> ₹<span id="totalGST">0.00</span></p>
                <p><strong>Invoice Count:</strong> <span id="invoiceCount">0</span></p>
            </div>
        </div>
        
        <div class="footer">
            <p>Copyright © KVR Associates</p>
        </div>
    </div>
    
    <script th:inline="javascript">
        const monthlyData = /*[[${monthlyRevenue}]]*/ {};
        const months = ['JANUARY', 'FEBRUARY', 'MARCH', 'APRIL', 'MAY', 'JUNE', 
                       'JULY', 'AUGUST', 'SEPTEMBER', 'OCTOBER', 'NOVEMBER', 'DECEMBER'];
        const values = months.map(m => monthlyData[m] || 0);
        
        new Chart(document.getElementById('monthlyChart'), {
            type: 'bar',
            data: {
                labels: months.map(m => m.substring(0, 3)),
                datasets: [{
                    label: 'Monthly Revenue (₹)',
                    data: values,
                    backgroundColor: '#6366f1',
                    borderColor: '#4f46e5',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: { 
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₹' + value.toLocaleString();
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Revenue: ₹' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
        
        async function loadGSTSummary() {
            const start = document.getElementById('gstStartDate').value;
            const end = document.getElementById('gstEndDate').value;
            if (!start || !end) {
                alert('Please select both dates');
                return;
            }
            const response = await fetch(`/analytics/gst-summary?startDate=${start}&endDate=${end}`);
            const data = await response.json();
            document.getElementById('totalCGST').textContent = data.totalCGST.toFixed(2);
            document.getElementById('totalSGST').textContent = data.totalSGST.toFixed(2);
            document.getElementById('totalGST').textContent = data.totalGST.toFixed(2);
            document.getElementById('invoiceCount').textContent = data.invoiceCount;
            document.getElementById('gstSummary').style.display = 'block';
        }
    </script>
    <script th:replace="~{fragments/header :: menuScript}"></script>
</body>
</html>
